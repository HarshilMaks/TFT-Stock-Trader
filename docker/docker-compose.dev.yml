version: '3.9'

# ═════════════════════════════════════════════════════════════════════════════
# TFT Trader — Docker Compose for Local Development
# ═════════════════════════════════════════════════════════════════════════════
# 
# This compose file sets up a complete local development environment with:
# - PostgreSQL database
# - Redis cache & task broker
# - Celery worker (executes scraping & ML tasks)
# - Celery Beat scheduler (schedules tasks on cron-like schedule)
# - Flower (optional UI for monitoring Celery)
#
# Quick start:
#   docker-compose -f docker-compose.dev.yml up -d
#   docker-compose -f docker-compose.dev.yml logs -f
#
# Services will use environment variables from .env file in project root.
# See .env.example for required variables.
# ═════════════════════════════════════════════════════════════════════════════

services:
  # ───────────────────────────────────────────────────────────────────────────
  # PostgreSQL Database
  # ───────────────────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: tft-postgres
    environment:
      POSTGRES_USER: stockuser
      POSTGRES_PASSWORD: stockpass123
      POSTGRES_DB: stockmarket
      POSTGRES_INITDB_ARGS: "-c timezone=UTC"
    ports:
      - "5432:5432"
    volumes:
      # Data persistence across restarts
      - postgres_data:/var/lib/postgresql/data
      # Optional: Initialize with SQL script on first run
      # - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stockuser"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tft-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ───────────────────────────────────────────────────────────────────────────
  # Redis Cache & Task Broker
  # ───────────────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: tft-redis
    ports:
      - "6379:6379"
    volumes:
      # Data persistence for task queue
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "PING"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tft-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: redis-server --appendonly yes --appendfsync everysec

  # ───────────────────────────────────────────────────────────────────────────
  # Celery Worker — Executes scraping and ML tasks
  # ───────────────────────────────────────────────────────────────────────────
  celery_worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: development  # Optional: Use 'development' target if defined in Dockerfile
    container_name: tft-celery-worker
    command: celery -A backend.celery_app worker --loglevel=info --concurrency=2 --queues=scraping,ml
    environment:
      # Load from .env file in project root
      - DATABASE_URL=postgresql://stockuser:stockpass123@postgres:5432/stockmarket
      - REDIS_URL=redis://redis:6379/0
      # Add other env vars needed by the app
      - PYTHONUNBUFFERED=1
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      # Code hot-reload during development
      - ./backend:/app/backend
      - ./scripts:/app/scripts
      # Logs persistent directory
      - celery_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tft-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ───────────────────────────────────────────────────────────────────────────
  # Celery Beat — Scheduler for periodic tasks
  # ───────────────────────────────────────────────────────────────────────────
  celery_beat:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: tft-celery-beat
    command: celery -A backend.celery_app beat --loglevel=info --scheduler=celery.beat:PersistentScheduler
    environment:
      - DATABASE_URL=postgresql://stockuser:stockpass123@postgres:5432/stockmarket
      - REDIS_URL=redis://redis:6379/0
      - PYTHONUNBUFFERED=1
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      # Code hot-reload during development
      - ./backend:/app/backend
      # Schedule file persistence
      - ./celerybeat-schedule:/app/celerybeat-schedule
      # Logs persistent directory
      - celery_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tft-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ───────────────────────────────────────────────────────────────────────────
  # Flower — Celery Monitoring UI (Optional but recommended for development)
  # ───────────────────────────────────────────────────────────────────────────
  flower:
    image: mher/flower:2.0
    container_name: tft-flower
    command: celery --broker=redis://redis:6379 --port=5555
    ports:
      - "5555:5555"
    environment:
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tft-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5555"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ═════════════════════════════════════════════════════════════════════════════
# Volumes — Data persistence across container restarts
# ═════════════════════════════════════════════════════════════════════════════
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  celery_logs:
    driver: local

# ═════════════════════════════════════════════════════════════════════════════
# Networks — Allow containers to communicate with each other
# ═════════════════════════════════════════════════════════════════════════════
networks:
  tft-network:
    driver: bridge

# ═════════════════════════════════════════════════════════════════════════════
# Notes:
# 1. Database credentials: stockuser / stockpass123 (change in production!)
# 2. Environment variables:
#    - DATABASE_URL connects Celery and app to PostgreSQL
#    - REDIS_URL connects Celery to Redis
#    - Edit these if you change service names or credentials
# 3. Volumes:
#    - postgres_data: Persists database files
#    - redis_data: Persists queue/cache data  
#    - celery_logs: Persists Celery worker/beat logs
# 4. Health checks:
#    - Each service has a health check
#    - Celery worker/beat wait for postgres + redis to be healthy before starting
# 5. Logging:
#    - All services log to docker (json-file driver)
#    - View logs: docker-compose -f docker-compose.dev.yml logs -f [service_name]
# 6. Restart policy:
#    - unless-stopped: Services restart on failure but don't auto-start with Docker daemon
# ═════════════════════════════════════════════════════════════════════════════
